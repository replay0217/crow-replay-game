<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport"/>
<title>ã‚¯ãƒ­ã‚¦ï¼†ãƒªãƒ—ãƒ¬ã‚¤ã®ãƒã‚¤ãƒ›ãƒ¼ãƒ ï¼ˆæ”¾ç½®ï¼‰</title>
<link href="manifest.webmanifest" rel="manifest"/>
<meta content="#222222" name="theme-color"/>

<style>*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#121418;color:#f3f3f3;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{padding:12px 14px;background:#1b1f26;position:sticky;top:0;z-index:2;border-bottom:1px solid #2a2f38}
h1{font-size:18px;margin:0 0 6px 0}
.stats{display:flex;gap:16px;flex-wrap:wrap;font-size:14px;opacity:.95}
main{padding:14px;max-width:960px;margin:0 auto}
.characters{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:720px){.characters{grid-template-columns:1fr 1fr}}
.char-card{background:#1b1f26;border:1px solid #2a2f38;border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
.char-card h2{margin:.2rem 0 .3rem 0;font-size:18px}
.levels{opacity:.85;margin-bottom:8px}
.tap-btn{width:100%;padding:14px 12px;border:0;border-radius:10px;background:#2a7cf7;color:#fff;font-size:16px;font-weight:700}
.tap-btn.secondary{background:#27b36a}
.tap-btn:active{transform:scale(.98)}
.sub{font-size:12px;opacity:.8;margin:.4rem 0 0 0}
.shop{margin-top:10px}
.shop-grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){.shop-grid{grid-template-columns:1fr 1fr 1fr}}
.shop-item{background:#1b1f26;border:1px solid #2a2f38;border-radius:12px;padding:12px}
.shop-item h3{margin:.2rem 0 .2rem 0;font-size:16px}
.shop-item button{margin-top:6px;width:100%;padding:10px;border-radius:8px;border:0;background:#3a3f49;color:#fff;font-weight:700}
.shop-item button:disabled{opacity:.5}
.log-wrap{margin-top:10px}
.log{background:#0e1013;border:1px solid #2a2f38;border-radius:10px;padding:8px;height:160px;overflow:auto;font-size:12px}
footer{position:sticky;bottom:0;background:#1b1f26;border-top:1px solid #2a2f38;padding:10px;display:flex;gap:8px;align-items:center;justify-content:center}
footer .danger{background:#a23b3b;color:#fff;border:0;padding:10px 14px;border-radius:8px}
footer button{background:#3a3f49;color:#fff;border:0;padding:10px 14px;border-radius:8px}
.ver{margin-left:auto;margin-right:8px;opacity:.6;font-size:12px}
</style></head>
<body>
<header>
<h1>ã‚¯ãƒ­ã‚¦ï¼†ãƒªãƒ—ãƒ¬ã‚¤ã®ãƒã‚¤ãƒ›ãƒ¼ãƒ </h1>
<div class="stats">
<div>ğŸ’° ãŠé‡‘: <span id="money">0</span></div>
<div>ğŸ˜Š ãƒãƒƒãƒ”ãƒ¼: <span id="happy">0</span> / <span id="happyMax">100</span></div>
<div>ğŸ“ˆ ãƒãƒƒãƒ”ãƒ¼ãƒœãƒ¼ãƒŠã‚¹: <span id="happyMult">x1.00</span></div>
</div>
</header>
<main>
<section class="characters">
<div class="char-card">
<h2>ã‚¯ãƒ­ã‚¦ï¼ˆã‚´ãƒ¼ãƒ¬ãƒ è·äººï¼‰</h2>
<div class="levels">Lv.<span id="crowLevel">1</span></div>
<button class="tap-btn" id="tapCrow">ã‚¯ãƒ­ã‚¦ã‚’ã‚¿ãƒƒãƒ—ï¼ˆğŸ’°+<span id="crowTapVal">1</span>ï¼‰</button>
<p class="sub">â€»ã‚¯ãƒ­ã‚¦ã®ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‹ã¨ã‚¿ãƒƒãƒ—ãŠé‡‘â†‘ï¼ãƒãƒƒãƒ”ãƒ¼æ¸›å°‘â†‘</p>
</div>
<div class="char-card">
<h2>ãƒªãƒ—ãƒ¬ã‚¤ï¼ˆå®¶äº‹ãƒã‚¹ã‚¿ãƒ¼ï¼‰</h2>
<div class="levels">Lv.<span id="replayLevel">1</span></div>
<button class="tap-btn secondary" id="tapReplay">ãƒªãƒ—ãƒ¬ã‚¤ã‚’ã‚¿ãƒƒãƒ—ï¼ˆğŸ˜Š+<span id="replayTapVal">1</span>ï¼‰</button>
<p class="sub">â€»ãƒªãƒ—ãƒ¬ã‚¤ã®ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‹ã¨ã‚¿ãƒƒãƒ—ãƒãƒƒãƒ”ãƒ¼â†‘</p>
</div>
</section>
<section class="shop">
<h2>ã‚·ãƒ§ãƒƒãƒ—</h2>
<div class="shop-grid">
<div class="shop-item">
<h3>è‡ªå‹•ã‚¿ãƒƒãƒ—ï¼šã‚´ãƒ¼ãƒ¬ãƒ ã‚³ã‚¢</h3>
<p>æ¯ç§’ ã‚¯ãƒ­ã‚¦ã‚’ <b><span id="autoPerSec">0</span></b> å›ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
<button id="buyAuto">è³¼å…¥ï¼ˆğŸ’°<span id="autoCost">10</span>ï¼‰</button>
<p class="sub">ä»Šã®æ‰€æŒæ•°ï¼š<span id="autoCount">0</span></p>
</div>
<div class="shop-item">
<h3>ã‚¯ãƒ­ã‚¦ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</h3>
<p>ã‚¿ãƒƒãƒ—ğŸ’°â†‘ï¼ãƒãƒƒãƒ”ãƒ¼æ¸›å°‘â†‘</p>
<button id="lvlCrow">ä¸Šã’ã‚‹ï¼ˆğŸ˜Š<span id="crowLvlCost">10</span>ï¼‰</button>
</div>
<div class="shop-item">
<h3>ãƒªãƒ—ãƒ¬ã‚¤ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</h3>
<p>ã‚¿ãƒƒãƒ—ğŸ˜Šâ†‘</p>
<button id="lvlReplay">ä¸Šã’ã‚‹ï¼ˆğŸ˜Š<span id="replayLvlCost">10</span>ï¼‰</button>
</div>
</div>
</section>
<section class="log-wrap">
<h2>ãƒ­ã‚°</h2>
<div class="log" id="log"></div>
</section>
</main>
<footer>
<button id="saveBtn">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
<button class="danger" id="resetBtn">åˆæœŸåŒ–</button>
<span class="ver">v0.1 PWA</span>
</footer>

<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
<script>// ==== è¨­å®šï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰ ====
const CFG = {
  tickHz: 10,                 // ã‚²ãƒ¼ãƒ æ›´æ–°é »åº¦ï¼ˆæ¯ç§’ï¼‰
  baseHappyDecayPerSec: 0.2,  // åŸºæœ¬ãƒãƒƒãƒ”ãƒ¼æ¸›å°‘/ç§’
  extraDecayPerCrowLv: 0.05,  // ã‚¯ãƒ­ã‚¦Lv1ã”ã¨ã®è¿½åŠ ãƒãƒƒãƒ”ãƒ¼æ¸›å°‘/ç§’
  happyMaxBase: 100,          // ãƒãƒƒãƒ”ãƒ¼æœ€å¤§å€¤
  happyTapBase: 1,            // ãƒªãƒ—ãƒ¬ã‚¤åˆæœŸã‚¿ãƒƒãƒ—å€¤
  moneyTapBase: 1,            // ã‚¯ãƒ­ã‚¦åˆæœŸã‚¿ãƒƒãƒ—å€¤
  replayTapPerLv: 0.6,        // ãƒªãƒ—ãƒ¬ã‚¤Lvã”ã¨ã®ã‚¿ãƒƒãƒ—å¢—åŠ 
  crowTapPerLv: 0.8,          // ã‚¯ãƒ­ã‚¦Lvã”ã¨ã®ã‚¿ãƒƒãƒ—å¢—åŠ 
  happyBonusSlope: 1.0,       // ãƒãƒƒãƒ”ãƒ¼ãŒ100ã®æ™‚ã®å€ç‡ãŒ x(1 + slope)
  autoBaseCost: 10,
  autoCostMult: 1.15,         // è‡ªå‹•ã‚¿ãƒƒãƒ—ã®ã‚³ã‚¹ãƒˆä¸Šæ˜‡
  levelBaseCost: 10,
  levelCostMult: 1.25,        // Lvã‚³ã‚¹ãƒˆä¸Šæ˜‡ï¼ˆãƒãƒƒãƒ”ãƒ¼æ¶ˆè²»ï¼‰
  offlineCapHours: 12         // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åç›Šï¼ˆæœ€å¤§æ™‚é–“ï¼‰
};

// ==== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ====
let state = {
  money: 0,
  happy: 0,
  happyMax: CFG.happyMaxBase,
  crowLevel: 1,
  replayLevel: 1,
  autoCount: 0,
  autoCost: CFG.autoBaseCost,
  crowLvlCost: CFG.levelBaseCost,
  replayLvlCost: CFG.levelBaseCost,
  lastTs: Date.now()
};

// ==== ä¾¿åˆ©é–¢æ•° ====
const $ = (id) => document.getElementById(id);
const fmt = (n) => {
  if (n < 1000) return Math.floor(n).toString();
  const units = ['K','M','B','T','Qa','Qi','Sx','Sp','Oc','No','De'];
  let u = -1;
  let x = n;
  while (x >= 1000 && u < units.length - 1) { x /= 1000; u++; }
  return x.toFixed(2) + units[u];
};

function happyMultiplier() {
  // ä¾‹ï¼šhappy=100ã®ã¨ã x(1 + slope) ã«ãªã‚‹
  const ratio = Math.max(0, Math.min(1, state.happy / state.happyMax));
  return 1 + ratio * CFG.happyBonusSlope;
}

function crowTapValue() {
  return (CFG.moneyTapBase + (state.crowLevel - 1) * CFG.crowTapPerLv) * happyMultiplier();
}

function replayTapValue() {
  return CFG.happyTapBase + (state.replayLevel - 1) * CFG.replayTapPerLv;
}

function happyDecayPerSec() {
  return CFG.baseHappyDecayPerSec + (state.crowLevel - 1) * CFG.extraDecayPerCrowLv;
}

// ==== å…¥å‡ºåŠ›/UI ====
function log(msg) {
  const el = $('log');
  const time = new Date().toLocaleTimeString();
  el.innerHTML = `[${time}] ${msg}<br>` + el.innerHTML;
}

function refreshUI() {
  $('money').textContent = fmt(state.money);
  $('happy').textContent = Math.floor(state.happy);
  $('happyMax').textContent = Math.floor(state.happyMax);
  $('happyMult').textContent = 'x' + happyMultiplier().toFixed(2);
  $('crowLevel').textContent = state.crowLevel;
  $('replayLevel').textContent = state.replayLevel;
  $('crowTapVal').textContent = Math.floor(crowTapValue());
  $('replayTapVal').textContent = Math.floor(replayTapValue());
  $('autoPerSec').textContent = state.autoCount;
  $('autoCost').textContent = fmt(state.autoCost);
  $('autoCount').textContent = state.autoCount;
  $('crowLvlCost').textContent = Math.floor(state.crowLvlCost);
  $('replayLvlCost').textContent = Math.floor(state.replayLvlCost);
}

// ==== ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ ====
const SAVE_KEY = 'crow_replay_idle_save_v01';
function save() {
  state.lastTs = Date.now();
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  log('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ');
}
function load() {
  const s = localStorage.getItem(SAVE_KEY);
  if (!s) return;
  try {
    state = JSON.parse(s);
  } catch(e) {}
}

// ==== ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åç›Š ====
function applyOfflineGains() {
  const now = Date.now();
  const dtSec = Math.min((now - state.lastTs) / 1000, CFG.offlineCapHours * 3600);
  if (dtSec <= 1) return;

  const tapsFromAuto = state.autoCount * dtSec;
  const moneyGain = tapsFromAuto * crowTapValue(); // ãƒãƒƒãƒ”ãƒ¼å€ç‡ã¯æœ€å¾Œã®å€¤ã§è¨ˆç®—ï¼ˆè¿‘ä¼¼ï¼‰

  // ãƒãƒƒãƒ”ãƒ¼ã¯æ™‚é–“ã§æ¸›å°‘ï¼ˆä¸‹é™0ï¼‰
  const happyLoss = happyDecayPerSec() * dtSec;
  state.happy = Math.max(0, state.happy - happyLoss);

  state.money += moneyGain;
  log(`ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åç›Š: ğŸ’°+${fmt(moneyGain)} / ãƒãƒƒãƒ”ãƒ¼ -${Math.floor(happyLoss)}`);
}

// ==== ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— ====
let acc = 0;
function tick(dt) {
  // ãƒãƒƒãƒ”ãƒ¼æ¸›å°‘
  state.happy = Math.max(0, state.happy - happyDecayPerSec() * dt);

  // è‡ªå‹•ã‚¿ãƒƒãƒ—ã«ã‚ˆã‚‹ãŠé‡‘
  const taps = state.autoCount * dt; // 1ç§’ã« autoCount å›
  state.money += taps * crowTapValue();
}

function loop(ts) {
  const now = performance.now();
  const dt = 1 / CFG.tickHz;
  acc += dt;
  tick(dt);
  refreshUI();
  setTimeout(loop, 1000 / CFG.tickHz);
}

// ==== æ“ä½œ ====
$('tapCrow').addEventListener('click', () => {
  const gain = crowTapValue();
  state.money += gain;
  refreshUI();
});

$('tapReplay').addEventListener('click', () => {
  state.happy = Math.min(state.happyMax, state.happy + replayTapValue());
  refreshUI();
});

$('buyAuto').addEventListener('click', () => {
  if (state.money < state.autoCost) return;
  state.money -= state.autoCost;
  state.autoCount += 1;
  state.autoCost = Math.floor(state.autoCost * CFG.autoCostMult);
  refreshUI();
  log('ã‚´ãƒ¼ãƒ¬ãƒ ã‚³ã‚¢ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼ˆè‡ªå‹•ã‚¿ãƒƒãƒ—+1/ç§’ï¼‰');
});

$('lvlCrow').addEventListener('click', () => {
  if (state.happy < state.crowLvlCost) return;
  state.happy -= state.crowLvlCost;
  state.crowLevel += 1;
  state.crowLvlCost = Math.floor(state.crowLvlCost * CFG.levelCostMult);
  refreshUI();
  log('ã‚¯ãƒ­ã‚¦ã®ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã£ãŸï¼ğŸ’°ã‚¿ãƒƒãƒ—â†‘ï¼ãƒãƒƒãƒ”ãƒ¼æ¸›å°‘â†‘');
});

$('lvlReplay').addEventListener('click', () => {
  if (state.happy < state.replayLvlCost) return;
  state.happy -= state.replayLvlCost;
  state.replayLevel += 1;
  state.replayLvlCost = Math.floor(state.replayLvlCost * CFG.levelCostMult);
  refreshUI();
  log('ãƒªãƒ—ãƒ¬ã‚¤ã®ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã£ãŸï¼ğŸ˜Šã‚¿ãƒƒãƒ—â†‘');
});

$('saveBtn').addEventListener('click', save);
$('resetBtn').addEventListener('click', () => {
  if (!confirm('æœ¬å½“ã«åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem(SAVE_KEY);
  location.reload();
});

// ==== èµ·å‹• ====
load();
applyOfflineGains();
state.lastTs = Date.now();
refreshUI();
setTimeout(loop, 1000 / CFG.tickHz);
</script></body>
</html>
